<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Calories & Nutrition (local)</title>

<style>
  :root{
    --bg:#0b1020;
    --panel:rgba(255,255,255,.08);
    --panel2:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.14);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.70);
    --muted2:rgba(255,255,255,.55);
    --shadow: 0 18px 55px rgba(0,0,0,.35);
    --radius: 18px;

    --ok: rgba(46, 204, 113, .16);
    --warn: rgba(241, 196, 15, .16);
    --bad: rgba(231, 76, 60, .16);

    --ok-b: rgba(46, 204, 113, .35);
    --warn-b: rgba(241, 196, 15, .35);
    --bad-b: rgba(231, 76, 60, .35);

    --accent: #7c5cff;
    --accent2:#2dd4bf;
  }

  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    margin:0;
    color:var(--text);
    background:
      radial-gradient(1100px 700px at 12% 12%, rgba(124,92,255,.25), transparent 60%),
      radial-gradient(1000px 700px at 90% 10%, rgba(45,212,191,.20), transparent 55%),
      radial-gradient(900px 700px at 50% 110%, rgba(255,255,255,.08), transparent 55%),
      var(--bg);
    line-height:1.35;
  }

  .container{
    max-width: 1050px;
    margin: 0 auto;
    padding: 16px;
  }

  h1{
    font-size:1.25rem;
    margin:.2rem 0 .6rem;
    letter-spacing:.2px;
  }
  h2{margin:.1rem 0 .6rem;font-size:1.05rem}
  h3{margin:.1rem 0 .6rem;font-size:1rem}

  .muted{color:var(--muted);font-size:.92rem}
  .muted small{color:var(--muted2)}
  a{color:inherit}

  /* --- Top bar --- */
  .appbar{
    position:sticky; top:0; z-index:1000;
    backdrop-filter: blur(12px);
    background: linear-gradient(to bottom, rgba(11,16,32,.88), rgba(11,16,32,.68));
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .appbar__inner{
    display:flex; align-items:center; gap:12px;
    max-width:1050px;
    margin:0 auto;
    padding: 12px 16px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    min-width: 240px;
  }
  .logoDot{
    width:34px;height:34px;border-radius:12px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    box-shadow: 0 10px 30px rgba(124,92,255,.25);
  }
  .brandTitle{font-weight:800; line-height:1.05}
  .brandSub{font-size:.82rem;color:var(--muted); margin-top:2px}

  /* --- Tabs --- */
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-left:auto;
    align-items:center;
  }
  .tabBtn{
    width:auto;
    min-width:auto;
    padding: .5rem .75rem;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
    font-weight:650;
    transition: transform .05s ease, background .15s ease, border-color .15s ease;
  }
  .tabBtn:hover{background: rgba(255,255,255,.10)}
  .tabBtn:active{transform: translateY(1px)}
  .tabBtn.is-active{
    background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(45,212,191,.25));
    border-color: rgba(255,255,255,.28);
  }

  /* Date dans l'appbar (global, compact) */
  .dateMini{
    width:auto;
    min-width: 155px;
    padding:.42rem .55rem;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.16);
    color: var(--text);
    font-weight:650;
  }
  .dateMini:focus{
    border-color: rgba(124,92,255,.55);
    box-shadow: 0 0 0 4px rgba(124,92,255,.20);
    outline:none;
  }

  /* --- Layout --- */
  .grid{display:grid;grid-template-columns:1fr;gap:.9rem}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

  .card{
    border:1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    box-shadow: var(--shadow);
    padding: 1rem;
    margin: .9rem 0;
    width:100%;
  }

  label{
    display:block;
    font-size:.92rem;
    margin:.2rem 0 .25rem;
    color: rgba(255,255,255,.82);
    font-weight:650;
  }

  input,select,button,textarea{
    width:100%;
    padding:.55rem .6rem;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.16);
    color: var(--text);
    font-size:.98rem;
    outline:none;
  }

  input::placeholder, textarea::placeholder{color: rgba(255,255,255,.45)}
  input:focus,select:focus,textarea:focus{
    border-color: rgba(124,92,255,.55);
    box-shadow: 0 0 0 4px rgba(124,92,255,.20);
  }

  button{
    border:1px solid rgba(255,255,255,.18);
    background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(124,92,255,.15));
    cursor:pointer;
    font-weight:750;
  }
  button:hover{filter: brightness(1.05)}
  .btn-danger{
    border-color: rgba(231,76,60,.55);
    background: linear-gradient(135deg, rgba(231,76,60,.35), rgba(231,76,60,.15));
  }
  .btn-mini{
    padding:.28rem .55rem;
    border-radius: 12px;
    width:auto;
  }

  .row{display:flex;gap:.7rem;flex-wrap:wrap}
  .row > div{flex:1;min-width:190px}

  .kpi{display:flex;gap:.6rem;flex-wrap:wrap;margin:.7rem 0}
  .kpi div{
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius: 16px;
    padding:.55rem .7rem;
  }
  .kpi b{display:block;color: rgba(255,255,255,.90); margin-bottom:2px}

  .ok{background: var(--ok) !important; border-color: var(--ok-b) !important}
  .warn{background: var(--warn) !important; border-color: var(--warn-b) !important}
  .bad{background: var(--bad) !important; border-color: var(--bad-b) !important}

  /* --- Table --- */
  .table-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    width:100%;
    border-radius: 16px;
  }
  table{width:100%;border-collapse:collapse;margin-top:.5rem;background: rgba(0,0,0,.12)}
  th,td{
    border:1px solid rgba(255,255,255,.10);
    padding:.55rem;
    text-align:center
  }
  th{
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.88);
  }
  .td-left{text-align:left}

  textarea{
    min-height:110px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size:.87rem
  }

#daysJsonBox{
  min-height: 140px;
  font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:.85rem;
}

  /* --- “mise en garde” blocks --- */
  .notice{
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    padding:.75rem .85rem;
    background: rgba(255,255,255,.06);
    margin:.6rem 0;
  }
  .notice--warn{background: var(--warn); border-color: var(--warn-b)}
  .notice--ok{background: var(--ok); border-color: var(--ok-b)}
  .notice--bad{background: var(--bad); border-color: var(--bad-b)}
  .noticeTitle{font-weight:850;margin-bottom:.25rem}
  .notice p{margin:.25rem 0;color: rgba(255,255,255,.88)}
  .notice ul{margin:.35rem 0 0; padding-left:1.1rem; color: rgba(255,255,255,.85)}
  .notice li{margin:.15rem 0}

  /* --- Tooltip / info dot --- */
  .info-dot{
    display:inline-flex;align-items:center;justify-content:center;
    width:22px;height:22px;border-radius:999px;
    border:1px solid rgba(255,255,255,.22);
    font-size:13px;line-height:1;margin-left:.35rem;
    color:rgba(255,255,255,.92);
    background: rgba(0,0,0,.18);
    cursor:help; user-select:none;
  }

  /* Tooltip CSS-only (hover + focus) */
  .tip{ position:relative; }
  .tip::after{
    content: attr(data-tip);
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom: calc(100% + 10px);
    width: min(340px, 90vw);
    white-space: pre-wrap;
    background:#0b0f1a;
    color:#fff;
    border-radius:14px;
    padding:.7rem .8rem;
    font-size:.92rem;
    line-height:1.25;
    opacity:0; visibility:hidden; pointer-events:none;
    z-index:9999;
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.12);
  }
  .tip::before{
    content:"";
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom: calc(100% + 4px);
    border:6px solid transparent;
    border-top-color:#0b0f1a;
    opacity:0; visibility:hidden; pointer-events:none;
    z-index:9999;
  }
  .tip:hover::after, .tip:hover::before,
  .tip:focus::after, .tip:focus::before,
  .tip:focus-visible::after, .tip:focus-visible::before{
    opacity:1; visibility:visible;
  }

  /* Mini-modale */
  .modal{ display:none; }
  .modal.is-open{ display:block; }
  .modal__backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9998; }
  .modal__panel{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:min(560px, 92vw);
    max-height: 78vh;
    overflow:auto;
    background: rgba(12,16,28,.92);
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.14);
    z-index:9999;
    box-shadow: 0 20px 75px rgba(0,0,0,.55);
  }
  .modal__head{
    display:flex; align-items:center; justify-content:space-between;
    gap:.6rem;
    padding:.85rem .9rem;
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .modal__title{ font-weight:900; }
  .modal__close{ width:auto; min-width:auto; padding:.35rem .55rem; border-radius:12px; }
  .modal__body{
    padding:.85rem .9rem;
    white-space:pre-wrap;
    line-height:1.35;
    font-size:.98rem;
    color: rgba(255,255,255,.90);
  }
  .modal__foot{
    padding:.75rem .9rem;
    border-top:1px solid rgba(255,255,255,.10);
    display:flex; justify-content:flex-end;
  }

  /* Onglets → sections */
  .tabSection{ display:none; }
  .tabSection.is-active{ display:block; }

  /* Affichage conditionnel (modes) */
  [data-um="sport"], [data-um="expert"]{ display:none; }
  body[data-usemode="sport"] [data-um="sport"]{ display:block; }
  body[data-usemode="expert"] [data-um="sport"],
  body[data-usemode="expert"] [data-um="expert"]{ display:block; }

  /* Petit badge régime */
  .pill{
    display:inline-flex;align-items:center;gap:.4rem;
    padding:.2rem .55rem;
    border:1px solid rgba(255,255,255,.16);
    border-radius:999px;
    background: rgba(0,0,0,.18);
    font-size:.85rem;color: rgba(255,255,255,.90);
  }
  .pill b{font-weight:800}

  details summary::-webkit-details-marker{display:none}
  details summary:before{content:"▸ "; display:inline-block; margin-right:.2rem}
  details[open] summary:before{content:"▾ "}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
</head>

<body>
  <div class="appbar">
    <div class="appbar__inner">
      <div class="brand">
        <div class="logoDot" aria-hidden="true"></div>
        <div>
          <div class="brandTitle">Montre • Calories & Nutrition</div>
          <div class="brandSub">Local • multi-profils • synchro en option</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Navigation">
        <button class="tabBtn is-active" type="button" data-tab="dash">Aperçu</button>
        <button class="tabBtn" type="button" data-tab="repas">Repas</button>
        <button class="tabBtn" type="button" data-tab="journal">Suivi</button>
        <button class="tabBtn" type="button" data-tab="cloud">Synchronisation</button>
    </div>
  </div>

  <div class="container">
    <div class="notice notice--warn" style="margin-top:.6rem">
      <div class="noticeTitle">Bon à savoir</div>
      <p>Tu saisis tes données, l’application calcule des repères. <b>La montre reste une estimation</b>, ça ne remplace pas un avis médical.</p>
    </div>

    <!-- =========================
         DASHBOARD
         ========================= -->
    <section class="tabSection is-active" data-tabsection="dash">
      <div class="card" id="positioningCard">
        <h2>Rôle de l'application et ses limites d'utilisation</h2>

        <p class="muted" style="margin:.3rem 0 .6rem">
          Outil <b>local</b> pour suivre ta dépense (montre) et organiser ton suivi.
          <b>Ce n’est pas un avis médical</b> et <b>la montre reste une estimation</b>.
        </p>

        <div class="notice notice--ok">
          <div class="noticeTitle">Ce que l’app fait</div>
          <p>Elle centralise ton profil, ta dépense du jour, et ton suivi (repas + journal) à partir des onglets.</p>
        </div>

        <div class="notice notice--warn">
          <div class="noticeTitle">Ce que l’app ne fait pas</div>
          <ul>
            <li>Elle ne donne pas une vérité “au jour le jour” : vise la tendance.</li>
            <li>Si fatigue/sommeil/perf se dégradent : allège déficit ou charge.</li>
            <li>Si situation médicale particulière : fais valider par un pro de santé.</li>
          </ul>
        </div>

        <div class="row">
          <div>
            <label>Mode d’usage (affichage)</label>
            <select id="useMode">
              <option value="simple" selected>Simple</option>
              <option value="sport">Sportif</option>
              <option value="expert">Expert</option>
            </select>

            <div class="muted" style="margin-top:.25rem">
              Change l’affichage (les calculs restent identiques).
            </div>
          </div>

          <div>
            <label>Rappel rapide</label>
            <div class="muted" id="positioningText" style="margin-top:.15rem">
              Mode simple : vise la régularité sur 7 jours, pas le chiffre parfait au quotidien.
            </div>
          </div>
        </div>

        <details id="limitsDetails" style="margin-top:.6rem">
          <summary class="muted" style="cursor:pointer">Limites & responsabilités (à lire une fois)</summary>
          <ul class="muted" style="margin:.5rem 0 0; padding-left:1.1rem">
            <li>La dépense “montre” est une <b>estimation</b> : vise la <b>tendance</b>, pas le chiffre parfait.</li>
            <li>Si pathologie / traitement / TCA / grossesse : fais valider par un pro de santé.</li>
            <li>Si fatigue/sommeil/perf se dégradent : ajuste déficit, charge et récupération.</li>
          </ul>
        </details>
      </div>

      <div class="card">
        <h2>Profils (plusieurs utilisateurs)</h2>
        <div class="row">
          <div>
            <label>Profil actif</label>
            <select id="profileSelect"></select>
          </div>
          <div>
            <label>Nouveau profil (nom/identifiant)</label>
            <input id="profileName" type="text" placeholder="ex: Christophe…" />
          </div>
          <div style="align-self:flex-end">
            <button id="btnCreateProfile" type="button">Créer & activer</button>
          </div>
          <div style="align-self:flex-end">
            <button id="btnDeleteProfile" class="btn-danger" type="button">Supprimer ce profil</button>
          </div>
        </div>
        <p class="muted">
          Chaque profil a son journal (jours + repas + poids/mesures) séparé dans le navigateur.
        </p>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Profil (pour mémoire / cohérence)</h2>
          <div class="row">
            <div>
              <label>Sexe</label>
              <select id="sex">
                <option value="M" selected>Homme</option>
                <option value="F">Femme</option>
              </select>
            </div>
            <div>
              <label>Âge (ans)</label>
              <input id="age" type="number" min="0" step="1" value="48" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Taille (cm)</label>
              <input id="height" type="number" min="0" step="1" value="182" />
            </div>
            <div>
              <label>Poids profil (kg)</label>
              <input id="weight" type="number" min="0" step="0.1" value="84" />
            </div>
          </div>
          <p class="muted">
            Le poids “profil” sert de référence. Le poids “mesuré” (journal) sert au suivi.
          </p>
        </div>

        <div class="card">
          <h2>Dépense du jour (Montre)</h2>

          <div class="row">
            <div>
              <label>Profil de montre (pont de départ)</label>
              <select id="watchBrand">
                <option value="custom" selected>Personnalisé</option>
                <option value="apple">Apple</option>
                <option value="garmin">Garmin</option>
                <option value="polar">Polar</option>
                <option value="coros">COROS</option>
                <option value="samsung">Samsung</option>
                <option value="suunto">Suunto</option>
                <option value="huawei">Huawei</option>
                <option value="amazfit">Amazfit</option>
                <option value="fitbit">Fitbit / Google</option>
              </select>
              <div class="muted" style="margin-top:.25rem">
                La marque sert de <b>point de départ</b> : elle propose une marge d’erreur par défaut.
              </div>
            </div>

            <!-- Sport+Expert : référence preset (info) -->
            <div data-um="sport">
              <label>Référence preset (info)</label>
              <div style="margin-top:.25rem">
                <span
                  id="watchProfileInfo"
                  class="info-dot tip"
                  tabindex="0"
                  role="button"
                  aria-label="Infos profil de montre"
                  data-tip="Choisis une montre pour voir les notes."
                >ℹ️</span>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Dépense Montre du jour (kcal)</label>
              <input id="montre" type="number" min="0" step="1" placeholder="ex: 3300" value="3300" />
            </div>

            <!-- Sport+Expert : marge d'erreur -->
            <div data-um="sport">
              <label>Marge d’erreur Montre (%)</label>
              <input id="errPct" type="number" min="0" step="1" value="10" />
              <p class="muted" style="margin:.15rem 0 0">Ordre de grandeur, pas une valeur exacte.</p>
            </div>
          </div>

          <!-- Prudence : Expert uniquement -->
          <div class="row" data-um="expert">
            <div>
              <label>Mode de prudence</label>
              <select id="errMode">
                <option value="none">Ignorer l’erreur</option>
                <option value="conservative" selected>Conservateur (Montre - erreur)</option>
                <option value="optimistic">Optimiste (Montre + erreur)</option>
              </select>
            </div>
            <div class="muted" style="align-self:flex-end">
              L’objectif (%) est dans “Répartition protéines / glucides / lipides” (onglet Repas).
            </div>
          </div>

          <p class="muted" style="margin:.2rem 0 0">
            = dépense affichée par la montre, ajustée selon la marge d’erreur choisie
          </p>

          <div class="row" style="margin-top:.35rem">
            <div style="align-self:flex-end">
              <button id="calcSpendBtn" type="button">Recalculer (mise à jour des résultats)</button>
            </div>
          </div>

          <p class="muted" id="watchNote" data-um="sport">
            Note : la montre n’affiche pas une vérité : elle estime (profil + fréquence cardiaque + mouvement).
            La marge d’erreur (%) est un repère, pas une certitude.
          </p>
        </div>
      </div>
    </section>

    <!-- =========================
         REPAS
         ========================= -->
    <section class="tabSection" data-tabsection="repas">
      <div class="grid">
        <div class="card">
          <h2>Répartition protéines / glucides / lipides</h2>

          <div class="row">
            <div>
              <label>Type de régime (preset)</label>
              <select id="dietMode">
                <option value="cut_standard" selected>Standard (sportif)</option>
                <option value="cut_aggressive">Agressif (court terme)</option>
                <option value="recomp">Recomposition (léger déficit)</option>
                <option value="maintain">Maintien / équilibre</option>
                <option value="endurance">Performance endurance (déficit minime)</option>
                <option value="custom">Personnalisé (manuel)</option>
              </select>
            </div>

            <div>
              <label>
                Objectif (%)
                <span
                  class="info-dot"
                  title="Multiplicateur appliqué sur la “Dépense corrigée”.&#10;&#10;Formule : cible kcal = dépense corrigée × (objectif/100).&#10;&#10;Repères :&#10;• Standard : 85% (~ -15%)&#10;• Agressif : 75% (~ -25%)&#10;• Recomp : 92% (~ -8%)&#10;• Maintien : 100%&#10;• Endurance : 95% (~ -5%)"
                >?</span>
              </label>
              <input id="goalPct" type="number" min="60" max="130" step="1" value="85" />
              <div class="muted" style="margin-top:.25rem">
                100% = maintien. &lt;100% = déficit. &gt;100% = surplus. (Appliqué sur “Dépense corrigée”.)
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Protéines (g/kg de poids)</label>
              <input id="protPerKg" type="number" min="0" step="0.1" value="2.0" />
            </div>
            <div>
              <label>Lipides (g/kg de poids)</label>
              <input id="fatPerKg" type="number" min="0" step="0.1" value="0.9" />
            </div>
            <div>
              <label>
                Glucides : calcul auto
                <span class="info-dot"
                  title="C (g) = (kcal cible - (P×4 + L×9)) / 4.&#10;Si négatif : affichage clampé à 0 + warning."
                >?</span>
              </label>
              <input id="carbAutoHint" disabled value="= calories restantes (clamp si négatif)" />
            </div>
          </div>

          <p class="muted" id="dietNote" style="margin-top:.2rem">
            Presets = valeurs de départ. Si tu modifies objectif/prot/lip, l’app bascule en “Personnalisé”.
          </p>

          <div class="row">
            <div>
              <label>Déjà consommé aujourd’hui (kcal) — total repas</label>
              <input id="eatenKcal" type="number" value="0" readonly />
            </div>
            <div>
              <label>Déjà consommé : protéines (g) — total repas</label>
              <input id="eatenP" type="number" value="0" readonly />
            </div>
            <div>
              <label>Déjà consommé : glucides (g) — total repas</label>
              <input id="eatenC" type="number" value="0" readonly />
            </div>
            <div>
              <label>Déjà consommé : lipides (g) — total repas</label>
              <input id="eatenF" type="number" value="0" readonly />
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Repas du jour (historique + total automatique)</h2>
<!-- 1) Nom du repas (commun aux 2 méthodes) -->
<div class="row">
  <div style="min-width:220px;flex:2">
    <label>Nom du repas</label>
    <input id="mealName" type="text" placeholder="ex: Petit-déj, Pancakes, Collation, Dîner…" />
  </div>
</div>

<!-- 2) Sous-dashboard MANUEL (kcal/P/G/L) -->
<div class="card" style="background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.10);margin:.6rem 0;padding:.8rem">
  <h3>Apport du repas (manuel)</h3>
  <p class="muted">Saisie directe : kcal / P / G / L.</p>

  <div class="row" style="margin-top:.4rem">
    <div><label>kcal</label><input id="mealK" type="number" min="0" step="1" value="0" /></div>
    <div><label>P (g)</label><input id="mealP" type="number" min="0" step="0.1" value="0" /></div>
    <div><label>G (g)</label><input id="mealC" type="number" min="0" step="0.1" value="0" /></div>
    <div><label>L (g)</label><input id="mealF" type="number" min="0" step="0.1" value="0" /></div>
  </div>

  <p class="muted" style="margin-top:.2rem">
    Astuce : si tu utilises l’option rapide /100 g, ces champs se remplissent automatiquement.
  </p>
</div>


<div class="card" data-um="expert" style="background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.10);margin:.6rem 0;padding:.8rem">
          <h3 data-um="expert">Option rapide /100 g (facultatif)</h3>
<p class="muted" data-um="expert">
  Remplit automatiquement kcal / P / G / L à partir d’un emballage.
</p>
          <div class="row" style="margin-top:.4rem" data-um="expert">
            <div style="min-width:220px;flex:2">
              <label>kcal / 100 g (option rapide)</label>
              <input id="qKcal100" type="number" min="0" step="1" placeholder="ex: 420" />
            </div>
            <div>
              <label>Poids (g)</label>
              <input id="qWeight" type="number" min="0" step="1" placeholder="ex: 35" />
            </div>
            <div>
              <label>P / 100 g</label>
              <input id="qP100" type="number" min="0" step="0.1" placeholder="optionnel" />
            </div>
            <div>
              <label>G / 100 g</label>
              <input id="qC100" type="number" min="0" step="0.1" placeholder="optionnel" />
            </div>
            <div>
              <label>L / 100 g</label>
              <input id="qF100" type="number" min="0" step="0.1" placeholder="optionnel" />
            </div>
          </div>

          <div class="row" style="margin-top:.3rem" data-um="expert">
            <div style="align-self:flex-end">
              <button id="btnApplyPer100" type="button">Remplir à partir de /100 g</button>
            </div>
          </div>

          <p class="muted" style="margin-top:.2rem" data-um="expert">
            Exemple : barre 35 g à 420 kcal/100 g → entre 420 et 35, clique sur “Remplir”, puis “Ajouter ce repas”.
          </p>
</div>

          <div class="row">
            <div style="align-self:flex-end">
              <button id="btnAddMeal" type="button">Ajouter ce repas (nouvelle ligne)</button>
            </div>
            <div style="align-self:flex-end">
              <button id="btnClearMeals" class="btn-danger" type="button">Vider les repas du jour</button>
            </div>
          </div>

          <div id="mealsTableWrap"></div>
          <p class="muted" style="margin-top:.5rem">Tu peux éditer directement une cellule : le total se met à jour automatiquement.</p>
        </div>
      </div>

      <!-- Résultats (uniquement dans Repas) -->
      <div class="card" id="out" style="display:none;">
        <h2>Résultats</h2>
        <div class="kpi" id="kpis"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th></th><th>kcal</th><th>Protéines (g)</th><th>Glucides (g)</th><th>Lipides (g)</th>
              </tr>
            </thead>
            <tbody>
              <tr><th>Objectif du jour</th><td id="tK"></td><td id="tP"></td><td id="tC"></td><td id="tF"></td></tr>
              <tr><th>Déjà consommé</th><td id="eK"></td><td id="eP2"></td><td id="eC2"></td><td id="eF2"></td></tr>
              <tr><th>Reste à consommer</th><td id="rK"></td><td id="rP"></td><td id="rC"></td><td id="rF"></td></tr>
            </tbody>
          </table>
        </div>

        <p class="muted" id="notes"></p>
      </div>
    </section>

    <!-- =========================
         JOURNAL
         ========================= -->
    <section class="tabSection" data-tabsection="journal">
      <!-- Suivi poids & compo : Sport + Expert -->
      <div class="card" data-um="sport">
        <h2>>Historique (stocké localement)</h2>

        <div class="row">
          <div>
            <label>Poids (mesure standardisée) — pour la date sélectionnée</label>
            <input id="morningWeight" type="number" min="0" step="0.1" placeholder="ex: 83.6" />
          </div>
          <div>
            <label>Moyenne 7 jours (auto)</label>
            <input id="avg7Weight" disabled value="-" />
          </div>
          <div>
            <label>Variation hebdo (auto)</label>
            <input id="wkVarPct" disabled value="-" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Masse grasse (%)</label>
            <input id="fatPct" type="number" min="0" step="0.1" placeholder="ex: 18.5" />
          </div>
          <div>
            <label>Masse musculaire (%)</label>
            <input id="musclePct" type="number" min="0" step="0.1" placeholder="ex: 42.0" />
          </div>
          <div>
            <label>Masse osseuse (kg)</label>
            <input id="boneKg" type="number" min="0" step="0.1" placeholder="ex: 3.2" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>IMC (auto)</label>
            <input id="bmiVal" disabled value="-" />
          </div>
          <div>
            <label>Catégorie IMC (auto)</label>
            <input id="bmiCat" disabled value="-" />
          </div>
          <div>
            <label>Poids utilisé pour IMC</label>
            <input id="bmiWeightUsed" disabled value="-" />
          </div>
        </div>

        <!-- Tendance 7 jours : Expert uniquement -->
        <div class="card" data-um="expert" style="margin:.6rem 0; padding:.8rem">
          <h3>Tendance 7 jours (Expert)</h3>

          <div class="row">
            <div>
              <label>Moyenne dépense corrigée (kcal/j)</label>
              <input id="avg7SpendKcal" disabled value="-" />
            </div>
            <div>
              <label>Moyenne consommé (kcal/j)</label>
              <input id="avg7EatKcal" disabled value="-" />
            </div>
            <div>
              <label>Déficit estimé (kcal/j)</label>
              <input id="avg7DefKcal" disabled value="-" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Projection hebdo (kg/sem) — ordre de grandeur</label>
              <input id="projWkKg" disabled value="-" />
            </div>
            <div>
              <label>Poids réel vs théorique (7j vs 7j préc.)</label>
              <input id="deltaRealVsTheo" disabled value="-" />
            </div>
            <div>
              <label>Qualité des données (7j)</label>
              <input id="dataQuality7" disabled value="-" />
            </div>
          </div>

          <p class="muted" id="trend7Note" style="margin-top:.4rem">-</p>
        </div>

        <p class="muted">
          IMC = poids / taille². Poids utilisé = poids mesuré si encodé, sinon poids “profil”.
        </p>
      </div>

      <!-- Historique : visible pour tous -->
      <div class="card">
        <h2>Historique des journées (local)</h2>

        <div class="row">
  <div>
    <label>Choisir une date</label>
    <input id="dayDate" type="date" />
  </div>
  <div style="align-self:flex-end">
    <button id="btnDeleteDay" class="btn-danger" type="button">Supprimer journée</button>
  </div>
</div>

        <div id="daysHistory" class="muted" style="margin-top:.6rem"></div>
      </div>
    </section>

    <!-- =========================
         CLOUD
         ========================= -->
    <section class="tabSection" data-tabsection="cloud">
      <div class="card" id="cloudCard">
        <h2>Compte & synchronisation (cloud)</h2>

        <div class="row">
          <div style="min-width:240px;flex:2">
            <label>Email (pour activer la synchro)</label>
            <input id="cloudEmail" type="email" placeholder="ex: toi@email.com" />
            <div class="muted" style="margin-top:.25rem">
              Optionnel. Sans email : l’app reste en local
            </div>
          </div>

          <div style="align-self:flex-end">
            <button id="btnCloudLogin" type="button">Recevoir un lien</button>
          </div>

          <div style="align-self:flex-end">
            <button id="btnCloudLogout" type="button">Se déconnecter</button>
          </div>
        </div>

        <div class="row" style="margin-top:.3rem">
          <div style="align-self:flex-end">
            <button id="btnCloudPull" type="button">Récupérer (Pull)</button>
          </div>
          <div style="align-self:flex-end">
            <button id="btnCloudPush" type="button">Envoyer (Push)</button>
          </div>
          <div style="align-self:flex-end">
            <button id="btnCloudSync" type="button">Synchroniser (Pull → Fusion → Push)</button>
          </div>
        </div>

        <p class="muted" id="cloudStatus" style="margin-top:.45rem">
          État : local uniquement.
        </p>

        <details style="margin-top:.4rem">
          <summary class="muted" style="cursor:pointer">Comment ça marche</summary>
          <div class="muted" style="margin-top:.4rem">
            Pull = récupère la sauvegarde du cloud.<br/>
            Push = envoie ta sauvegarde locale au cloud.<br/>
            Synchroniser = Pull, fusion, puis Push.
          </div>
        </details>
    <!-- ✅ Sauvegarde manuelle (offline) — Expert uniquement -->
    <details data-um="expert" style="margin-top:.6rem">
      <summary class="muted" style="cursor:pointer">Sauvegarde manuelle (offline) — Plan B</summary>

      <div class="muted" style="margin-top:.4rem">
        Si tu n’as pas de cloud (ou pas de réseau), tu peux exporter un JSON et le recoller ailleurs.
        C’est volontairement caché en Simple/Sportif pour garder l’app lisible.
      </div>

      <div class="row" style="margin-top:.5rem">
        <div style="align-self:flex-end">
          <button id="btnExportDays" type="button">Exporter JSON</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnImportDays" type="button">Importer JSON</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnClearDays" class="btn-danger" type="button">Tout effacer (profil)</button>
        </div>
      </div>

      <textarea id="daysJsonBox" placeholder="JSON ici (export/import)…" style="margin-top:.55rem"></textarea>

      <div class="muted" style="margin-top:.35rem">
        Astuce : tu peux envoyer ce JSON sur un autre appareil, puis le coller ici et cliquer “Importer”.
      </div>
    </details>

      </div>
    </section>

    <!-- Modal -->
    <div id="watchInfoModal" class="modal" aria-hidden="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="watchInfoTitle">
        <div class="modal__head">
          <div id="watchInfoTitle" class="modal__title">Profil de montre</div>
          <button id="watchInfoClose" class="modal__close" type="button" aria-label="Fermer">✕</button>
        </div>
        <div id="watchInfoBody" class="modal__body"></div>
        <div class="modal__foot">
          <button id="watchInfoOk" type="button">OK</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      const $ = (id) => document.getElementById(id);
      const toNum = (v) => {
        const s = String(v ?? "").replace(",", ".").trim();
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      };
      const round = (v, d=1) => {
        const f = Math.pow(10, d);
        return Math.round((v + Number.EPSILON) * f) / f;
      };
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

      function setActiveTab(tab){
        const buttons = document.querySelectorAll(".tabBtn");
        const sections = document.querySelectorAll(".tabSection");

        buttons.forEach(b => b.classList.toggle("is-active", b.dataset.tab === tab));
        sections.forEach(s => s.classList.toggle("is-active", s.dataset.tabsection === tab));

        try{ localStorage.setItem("secheapp.ui.activeTab", tab); }catch{}
      }

      function initTabs(){
        const saved = (() => {
          try{ return localStorage.getItem("secheapp.ui.activeTab") || "dash"; }catch{ return "dash"; }
        })();

        document.querySelectorAll(".tabBtn").forEach(btn => {
          btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
        });

        setActiveTab(saved);
      }

      /* =========================
         ✅ Supabase (à renseigner)
         ========================= */
      const SUPABASE_URL = "https://ztrqqtjktydibcznbpen.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_VvPPkGiqqRBj1QSsdVboGg_uHzO06-o";

      let supa = null;
      if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
        supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      function mifflinStJeor(sex, weightKg, heightCm, ageY) {
        if (sex === "M") return 10*weightKg + 6.25*heightCm - 5*ageY + 5;
        return 10*weightKg + 6.25*heightCm - 5*ageY - 161;
      }

      function isoToday() { return new Date().toISOString().slice(0,10); }
      function getSelectedDate() {
        const v = $("dayDate")?.value;
        return v && v.length === 10 ? v : isoToday();
      }

      /* =========================
         ✅ Magic link callback handler
         ========================= */
      async function handleMagicLinkCallback() {
        if (!supa) return;

        const params = new URLSearchParams(window.location.search);
        const token_hash = params.get("token_hash");
        const type = params.get("type") || "email";
        if (!token_hash) return;

        setCloudStatus("Validation du lien en cours...");

        const { error } = await supa.auth.verifyOtp({ token_hash, type });
        if (error) {
          setCloudStatus("Lien invalide/expiré : " + error.message);
          return;
        }

        window.history.replaceState({}, document.title, window.location.pathname);

        const { data } = await supa.auth.getSession();
        const email = data?.session?.user?.email || "utilisateur";
        setCloudStatus("connecté : " + email);
      }

      function bmiCategory(bmi) {
        if (!Number.isFinite(bmi) || bmi <= 0) return "-";
        if (bmi < 18.5) return "Insuffisance pondérale";
        if (bmi < 25)   return "Corpulence normale";
        if (bmi < 30)   return "Surpoids";
        return "Obésité";
      }

      const WATCH_ESTIMATION_PROFILES = {
        custom:{ label:"Personnalisé", defaultErrPct:20, defaultMode:"conservative", confidence:"variable", role:"aucune hypothèse", notes:"Aucune hypothèse implicite. L’erreur est définie par l’utilisateur." },
        apple:{ label:"Apple Watch", defaultErrPct:25, defaultMode:"conservative", confidence:"modérée", role:"profil statistique", notes:"Profil d’estimation initial. Forte variabilité selon l’activité." },
        garmin:{ label:"Garmin", defaultErrPct:20, defaultMode:"optimistic", confidence:"modérée", role:"profil statistique", notes:"Profil d’estimation initial. Variabilité importante selon contexte." },
        polar:{ label:"Polar", defaultErrPct:20, defaultMode:"optimistic", confidence:"modérée", role:"profil statistique", notes:"Profil d’estimation initial. L’énergie reste une estimation bruitée." },
        coros:{ label:"COROS", defaultErrPct:25, defaultMode:"optimistic", confidence:"limitée", role:"profil terrain", notes:"Peu de validations indépendantes sur l’énergie. Valeur prudente." },
        samsung:{ label:"Samsung", defaultErrPct:30, defaultMode:"conservative", confidence:"faible", role:"profil grand public", notes:"Valeur conservatrice par manque de données robustes." },
        suunto:{ label:"Suunto", defaultErrPct:25, defaultMode:"optimistic", confidence:"limitée", role:"profil terrain", notes:"Variabilité élevée selon l’activité." },
        huawei:{ label:"Huawei", defaultErrPct:30, defaultMode:"conservative", confidence:"faible", role:"profil grand public", notes:"Peu de données indépendantes sur l’estimation calorique." },
        amazfit:{ label:"Amazfit", defaultErrPct:30, defaultMode:"conservative", confidence:"faible", role:"profil grand public", notes:"Estimation calorique indicative uniquement." },
        fitbit:{ label:"Fitbit / Google", defaultErrPct:25, defaultMode:"conservative", confidence:"modérée", role:"profil statistique", notes:"Variabilité importante selon activité. Utile pour tendances." }
      };

      function applyBrandPreset(brandKey, force = false) {
        const p = WATCH_ESTIMATION_PROFILES[brandKey] || WATCH_ESTIMATION_PROFILES.custom;
        const infoEl = document.getElementById("watchProfileInfo");

        if (infoEl) {
          const lines = [
            `Profil : ${p.role || "repère initial"}`,
            `Niveau de confiance : ${p.confidence || "variable"}`,
            "",
            p.notes || "Aucune information complémentaire."
          ];
          infoEl.setAttribute("data-modaltext", lines.join("\n"));
        }

        if (force) {
          if ($("errPct")) $("errPct").value = p.defaultErrPct;
          if ($("errMode")) $("errMode").value = p.defaultMode;
        }
      }

      function setPositioningCopy(mode) {
        const el = $("positioningText");
        if (!el) return;

        if (mode === "sport") {
          el.textContent = "Mode sportif : vise un déficit tenable. Charge + déficit trop élevés = fatigue et performance en baisse.";
          return;
        }
        if (mode === "expert") {
          el.textContent = "Mode expert : la valeur du jour peut varier. Lis surtout la tendance sur 7 jours.";
          return;
        }
        el.textContent = "Mode simple : vise la régularité sur 7 jours. Affichage allégé, sans pression au quotidien.";
      }

      function applyUseMode(mode) {
        const m = (mode === "sport" || mode === "expert") ? mode : "simple";
        document.body.setAttribute("data-usemode", m);

        setPositioningCopy(m);

        const det = $("limitsDetails");
        if (det) det.open = (m === "expert");
      }

      /* ================== presets régime (objectif% + macros) ================== */
      const DIET_PRESETS = {
        cut_standard:   { label:"Standard (sportif)",     goalPct: 85,  protPerKg: 1.9, fatPerKg: 0.9 },
        cut_aggressive: { label:"Agressif (court terme)", goalPct: 75,  protPerKg: 2.2, fatPerKg: 0.8 },
        recomp:         { label:"Recomposition (léger déficit)",   goalPct: 92,  protPerKg: 1.8, fatPerKg: 0.9 },
        maintain:       { label:"Maintien / équilibre",           goalPct: 100, protPerKg: 1.6, fatPerKg: 1.0 },
        endurance:      { label:"Performance endurance",          goalPct: 95,  protPerKg: 1.7, fatPerKg: 0.9 }
      };

      function dietLabel(mode) {
        if (!mode) return "-";
        if (mode === "custom") return "Personnalisé";
        return DIET_PRESETS[mode]?.label || mode;
      }

      function setDietNote(mode, changed=false) {
        if (!$("dietNote")) return;
        if (mode === "custom") {
          $("dietNote").textContent = changed
            ? "Preset modifié → mode Personnalisé (tes valeurs restent telles quelles)."
            : "Mode personnalisé : tu contrôles objectif (%) + prot/lip manuellement.";
          return;
        }
        const p = DIET_PRESETS[mode];
        if (!p) { $("dietNote").textContent = "Preset sélectionné."; return; }
        $("dietNote").textContent = `Preset sélectionné (${p.label}) — tu peux l’ajuster : toute modification bascule en Personnalisé.`;
      }

      function applyDietPreset(mode) {
        if (mode === "custom") { setDietNote("custom", false); return; }
        const p = DIET_PRESETS[mode];
        if (!p) return;

        $("goalPct").value   = p.goalPct;
        $("protPerKg").value = p.protPerKg;
        $("fatPerKg").value  = p.fatPerKg;

        setDietNote(mode, false);
      }

      function forceCustomIfPresetEdited() {
        const mode = $("dietMode").value;
        if (mode === "custom") return;
        $("dietMode").value = "custom";
        setDietNote("custom", true);
      }
      /* ======================================================================== */

      function escapeHtml(s) {
        return String(s ?? "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }
      function makeDietBadge(dietMode, goalPct) {
        const label = dietLabel(dietMode);
        const pct = Number.isFinite(goalPct) ? Math.round(goalPct) : "-";
        return `<span class="pill"><b>${escapeHtml(label)}</b> ${pct}%</span>`;
      }

      const PROFILES_KEY = "secheapp.profiles.v1";
      const ACTIVE_PROFILE_KEY = "secheapp.activeProfile.v1";

      function slugProfile(name) {
        return String(name ?? "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "-")
          .replace(/[^a-z0-9\-_]/g, "")
          .slice(0, 40);
      }

      function loadProfiles() {
        try { return JSON.parse(localStorage.getItem(PROFILES_KEY) || "[]"); }
        catch { return []; }
      }
      function saveProfiles(list) { localStorage.setItem(PROFILES_KEY, JSON.stringify(list)); }
      function getActiveProfile() { return localStorage.getItem(ACTIVE_PROFILE_KEY) || ""; }
      function setActiveProfile(id) { localStorage.setItem(ACTIVE_PROFILE_KEY, id); }

      function ensureDefaultProfile() {
        let profiles = loadProfiles();
        if (profiles.length === 0) {
          profiles = [{ id: "default", label: "default" }];
          saveProfiles(profiles);
          setActiveProfile("default");
        }
        if (!getActiveProfile()) setActiveProfile(profiles[0].id);
      }

      function refreshProfileSelect() {
        const sel = $("profileSelect");
        if (!sel) return;
        const profiles = loadProfiles();
        const active = getActiveProfile();
        sel.innerHTML = "";
        for (const p of profiles) {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.label;
          if (p.id === active) opt.selected = true;
          sel.appendChild(opt);
        }
      }

      function daysKeyFor(profileId) { return `secheapp.${profileId}.days.v6`; }
      function settingsKeyFor(profileId) { return `secheapp.${profileId}.settings.v2`; }
      function DAYS_KEY() { return daysKeyFor(getActiveProfile() || "default"); }
      function SETTINGS_KEY() { return settingsKeyFor(getActiveProfile() || "default"); }

      function createOrActivateProfile(label) {
        const cleanLabel = String(label ?? "").trim();
        if (!cleanLabel) return;
        const id = slugProfile(cleanLabel) || "profile";
        let profiles = loadProfiles();
        if (!profiles.find(p => p.id === id)) {
          profiles.push({ id, label: cleanLabel });
          saveProfiles(profiles);
        }
        setActiveProfile(id);
        refreshProfileSelect();
        loadProfileSettings();
        refreshDaySelect();
        renderDaysHistory();
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);
      }

      function deleteActiveProfile() {
        const active = getActiveProfile();
        if (active === "default") { alert("Le profil 'default' ne peut pas être supprimé."); return; }
        localStorage.removeItem(daysKeyFor(active));
        localStorage.removeItem(settingsKeyFor(active));
        let profiles = loadProfiles().filter(p => p.id !== active);
        saveProfiles(profiles);
        const next = profiles[0]?.id || "default";
        setActiveProfile(next);
        refreshProfileSelect();
        loadProfileSettings();
        refreshDaySelect();
        renderDaysHistory();
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);
      }

      function saveProfileSettings() {
        const payload = {
          sex: $("sex").value,
          age: toNum($("age").value),
          height: toNum($("height").value),
          weight: toNum($("weight").value),

          watchBrand: $("watchBrand").value,
          montre: toNum($("montre").value),
          errPct: toNum($("errPct")?.value),
          errMode: $("errMode")?.value,

          dietMode: $("dietMode")?.value,
          goalPct: toNum($("goalPct")?.value),

          protPerKg: toNum($("protPerKg")?.value),
          fatPerKg: toNum($("fatPerKg")?.value),

          useMode: $("useMode")?.value || "simple",

          updatedAt: new Date().toISOString()
        };
        localStorage.setItem(SETTINGS_KEY(), JSON.stringify(payload));
      }

      function loadProfileSettings() {
        let payload = null;
        try { payload = JSON.parse(localStorage.getItem(SETTINGS_KEY()) || "null"); } catch {}
        if (!payload) return;

        const has = (k) => Object.prototype.hasOwnProperty.call(payload, k);

        if (has("sex") && payload.sex) $("sex").value = payload.sex;
        if (has("age")) $("age").value = payload.age;
        if (has("height")) $("height").value = payload.height;
        if (has("weight")) $("weight").value = payload.weight;

        if (has("watchBrand") && payload.watchBrand) $("watchBrand").value = payload.watchBrand;
        applyBrandPreset($("watchBrand").value, false);

        if (has("montre")) $("montre").value = payload.montre;
        if (has("errPct") && $("errPct")) $("errPct").value = payload.errPct;
        if (has("errMode") && payload.errMode && $("errMode")) $("errMode").value = payload.errMode;

        if (has("dietMode") && payload.dietMode && $("dietMode")) $("dietMode").value = payload.dietMode;

        if (has("useMode") && $("useMode")) {
          const v = payload.useMode;
          $("useMode").value = (v === "sport" || v === "expert") ? v : "simple";
        }

        if (has("goalPct") && $("goalPct")) $("goalPct").value = payload.goalPct;
        if (has("protPerKg") && $("protPerKg")) $("protPerKg").value = payload.protPerKg;
        if (has("fatPerKg") && $("fatPerKg")) $("fatPerKg").value = payload.fatPerKg;

        if ($("dietMode")) setDietNote($("dietMode").value, false);
        applyUseMode($("useMode")?.value || "simple");
      }

      function loadDays() {
        try { return JSON.parse(localStorage.getItem(DAYS_KEY()) || "[]"); }
        catch { return []; }
      }
      function saveDays(days) { localStorage.setItem(DAYS_KEY(), JSON.stringify(days)); }
      function getDay(dateStr) { return loadDays().find(d => d.date === dateStr) || null; }

      function upsertDay(dayObj) {
        const days = loadDays();
        const idx = days.findIndex(d => d.date === dayObj.date);
        if (idx >= 0) days[idx] = dayObj; else days.push(dayObj);
        saveDays(days);
        renderDaysHistory();
        refreshDaySelect();
      }

      function refreshDaySelect() {
        const sel = $("daySelect");
        if (!sel) return;
        const days = loadDays().sort((a,b) => b.date.localeCompare(a.date));
        sel.innerHTML = "";
        if (days.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "(aucune journée)";
          sel.appendChild(opt);
          return;
        }
        for (const d of days) {
          const opt = document.createElement("option");
          opt.value = d.date;
          opt.textContent = d.date;
          sel.appendChild(opt);
        }
      }

      function deleteDay(dateStr) {
        let days = loadDays();
        days = days.filter(d => d.date !== dateStr);
        saveDays(days);
        renderDaysHistory();
        refreshDaySelect();
      }

      function exportDays() {
        const payload = {
          version: 6,
          exportedAt: new Date().toISOString(),
          profile: getActiveProfile(),
          days: loadDays()
        };
        $("daysJsonBox").value = JSON.stringify(payload, null, 2);
      }

      function importDays() {
        const text = $("daysJsonBox").value.trim();
        if (!text) return;
        let payload;
        try { payload = JSON.parse(text); } catch { alert("JSON invalide"); return; }
        if (!payload || !Array.isArray(payload.days)) { alert("Format attendu: {days:[...]}."); return; }
        const existing = loadDays();
        const map = new Map(existing.map(d => [d.date, d]));
        for (const d of payload.days) {
          if (!d.date) continue;
          map.set(d.date, d);
        }
        saveDays(Array.from(map.values()));
        renderDaysHistory();
        refreshDaySelect();
      }

      function clearDays() {
        localStorage.removeItem(DAYS_KEY());
        renderDaysHistory();
        refreshDaySelect();
      }

      function normalizeMeal(m) {
        return {
          id: m.id || (crypto.randomUUID?.() ?? (`m_${Date.now()}_${Math.random().toString(16).slice(2)}`)),
          name: String(m.name ?? "").trim(),
          k: Math.max(0, toNum(m.k)),
          p: Math.max(0, toNum(m.p)),
          c: Math.max(0, toNum(m.c)),
          f: Math.max(0, toNum(m.f)),
          createdAt: m.createdAt || new Date().toISOString()
        };
      }

      function getMealsForDay(dateStr) {
        const d = getDay(dateStr);
        return Array.isArray(d?.meals) ? d.meals.map(normalizeMeal) : [];
      }

      function setMealsForDay(dateStr, meals) {
        const existing = getDay(dateStr) || { date: dateStr };
        const dayObj = { ...existing, date: dateStr, meals: meals.map(normalizeMeal), updatedAt: new Date().toISOString() };
        upsertDay(dayObj);
      }

      function mealsTotals(meals) {
        return meals.reduce((acc, m) => {
          acc.k += toNum(m.k); acc.p += toNum(m.p); acc.c += toNum(m.c); acc.f += toNum(m.f);
          return acc;
        }, {k:0,p:0,c:0,f:0});
      }

      function syncEatenFromMeals(dateStr) {
        const meals = getMealsForDay(dateStr);
        const t = mealsTotals(meals);
        if ($("eatenKcal")) $("eatenKcal").value = round(t.k, 0);
        if ($("eatenP")) $("eatenP").value = round(t.p, 1);
        if ($("eatenC")) $("eatenC").value = round(t.c, 1);
        if ($("eatenF")) $("eatenF").value = round(t.f, 1);
        return t;
      }

      function renderMealsTable(dateStr) {
        const wrap = $("mealsTableWrap");
        if (!wrap) return;

        const meals = getMealsForDay(dateStr).sort((a,b) => (a.createdAt||"").localeCompare(b.createdAt||""));

        if (meals.length === 0) {
  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="text-align:left">Repas</th>
            <th>kcal</th>
            <th>P</th>
            <th>G</th>
            <th>L</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6" class="muted">Aucun repas encodé pour cette journée.</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  syncEatenFromMeals(dateStr);
  return;
}


        wrap.innerHTML = `
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th style="text-align:left">Repas</th><th>kcal</th><th>P</th><th>G</th><th>L</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${meals.map(m => `
                  <tr data-mealid="${m.id}">
                    <td class="td-left"><input data-field="name" value="${escapeHtml(m.name)}" /></td>
                    <td><input data-field="k" type="number" min="0" step="1" value="${round(m.k,0)}" /></td>
                    <td><input data-field="p" type="number" min="0" step="0.1" value="${round(m.p,1)}" /></td>
                    <td><input data-field="c" type="number" min="0" step="0.1" value="${round(m.c,1)}" /></td>
                    <td><input data-field="f" type="number" min="0" step="0.1" value="${round(m.f,1)}" /></td>
                    <td><button class="btn-mini btn-danger" data-action="del" type="button">Suppr.</button></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;

        wrap.querySelectorAll("input").forEach(inp => {
          inp.addEventListener("change", () => {
            const tr = inp.closest("tr");
            const id = tr.getAttribute("data-mealid");
            const field = inp.getAttribute("data-field");
            const mealsNow = getMealsForDay(dateStr);
            const idx = mealsNow.findIndex(x => x.id === id);
            if (idx < 0) return;

            const updated = { ...mealsNow[idx] };
            if (field === "name") updated.name = inp.value;
            else updated[field] = toNum(inp.value);

            mealsNow[idx] = normalizeMeal(updated);
            setMealsForDay(dateStr, mealsNow);
            syncEatenFromMeals(dateStr);
            compute(true);
          });
        });

        wrap.querySelectorAll("button[data-action='del']").forEach(btn => {
          btn.addEventListener("click", () => {
            const tr = btn.closest("tr");
            const id = tr.getAttribute("data-mealid");
            const mealsNow = getMealsForDay(dateStr).filter(x => x.id !== id);
            setMealsForDay(dateStr, mealsNow);
            renderMealsTable(dateStr);
            compute(true);
          });
        });

        syncEatenFromMeals(dateStr);
      }

      function addMealFromInputs() {
        const dateStr = getSelectedDate();
        $("dayDate").value = dateStr;

        const name = $("mealName").value.trim() || "Repas";
        const m = normalizeMeal({
          name,
          k: toNum($("mealK").value),
          p: toNum($("mealP").value),
          c: toNum($("mealC").value),
          f: toNum($("mealF").value),
          createdAt: new Date().toISOString()
        });

        const mealsNow = getMealsForDay(dateStr);
        mealsNow.push(m);
        setMealsForDay(dateStr, mealsNow);

        $("mealName").value = "";
        $("mealK").value = 0; $("mealP").value = 0; $("mealC").value = 0; $("mealF").value = 0;

        renderMealsTable(dateStr);
        compute(true);
      }

      function clearMealsForDay() {
        const dateStr = getSelectedDate();
        if (!confirm(`Vider tous les repas de la journée ${dateStr} ?`)) return;
        $("dayDate").value = dateStr;
        setMealsForDay(dateStr, []);
        renderMealsTable(dateStr);
        compute(true);
      }

      function applyPer100ToMeal() {
        const k100 = toNum($("qKcal100")?.value);
        const g    = toNum($("qWeight")?.value);
        const p100 = toNum($("qP100")?.value);
        const c100 = toNum($("qC100")?.value);
        const f100 = toNum($("qF100")?.value);

        if (k100 > 0 && g > 0) $("mealK").value = round(k100 * g / 100, 0);
        if (p100 > 0 && g > 0) $("mealP").value = round(p100 * g / 100, 1);
        if (c100 > 0 && g > 0) $("mealC").value = round(c100 * g / 100, 1);
        if (f100 > 0 && g > 0) $("mealF").value = round(f100 * g / 100, 1);
      }

      function computeWeightStats(dateStr, daysArr) {
        const sorted = [...daysArr].sort((a,b)=>a.date.localeCompare(b.date));
        const eligible = sorted.filter(d => d.date <= dateStr && toNum(d.morningWeight) > 0);
        const last7 = eligible.slice(-7);

        if (last7.length === 0) return { avg7:null, wkVar:null };

        const avg7 = last7.reduce((s,d)=>s + toNum(d.morningWeight), 0) / last7.length;

        const prevPool = eligible.slice(0, Math.max(0, eligible.length - last7.length));
        const prev7 = prevPool.slice(-7);
        let wkVar = null;
        if (prev7.length >= 3) {
          const prevAvg = prev7.reduce((s,d)=>s + toNum(d.morningWeight), 0) / prev7.length;
          wkVar = ((avg7 - prevAvg) / prevAvg) * 100;
        }
        return { avg7, wkVar };
      }

      function safeNum(v) {
        const n = toNum(v);
        return Number.isFinite(n) ? n : 0;
      }

      function getDayEatenKcal(dayObj) {
        if (dayObj?.eaten && Number.isFinite(toNum(dayObj.eaten.k))) return safeNum(dayObj.eaten.k);
        if (Array.isArray(dayObj?.meals)) {
          return dayObj.meals.reduce((s,m)=> s + safeNum(m?.k), 0);
        }
        return 0;
      }

      function compute7dEnergyTrend(dateStr, daysArr) {
        const sorted = [...daysArr].sort((a,b)=>a.date.localeCompare(b.date));
        const eligible = sorted.filter(d => d.date <= dateStr);
        const last7 = eligible.slice(-7);

        if (last7.length === 0) {
          return {
            n: 0,
            spendAvg: null,
            eatAvg: null,
            defAvg: null,
            projWkKg: null,
            quality: { days:0, spendDays:0, eatDays:0, weightDays:0 },
            theoWkKg: null,
            realWkKg: null
          };
        }

        let spendSum = 0, spendDays = 0;
        let eatSum = 0, eatDays = 0;
        let weightDays = 0;

        for (const d of last7) {
          const spend = safeNum(d?.montreAdjusted);
          if (spend > 0) { spendSum += spend; spendDays++; }

          const eatenK = getDayEatenKcal(d);
          const hasMeals = Array.isArray(d?.meals) && d.meals.length > 0;
          if (hasMeals || eatenK > 0) { eatSum += eatenK; eatDays++; }

          if (safeNum(d?.morningWeight) > 0) weightDays++;
        }

        const spendAvg = spendDays ? (spendSum / spendDays) : null;
        const eatAvg   = eatDays ? (eatSum / eatDays) : null;
        const defAvg   = (spendAvg != null && eatAvg != null) ? (spendAvg - eatAvg) : null;

        const projWkKg = (defAvg != null) ? ((defAvg * 7) / 7700) : null;

        const eligibleWithWeight = sorted.filter(d => d.date <= dateStr && safeNum(d?.morningWeight) > 0);
        const last14w = eligibleWithWeight.slice(-14);

        let realWkKg = null;
        if (last14w.length >= 10) {
          const second7 = last14w.slice(-7);
          const first7  = last14w.slice(0, last14w.length - 7).slice(-7);

          const avgA = second7.reduce((s,d)=> s + safeNum(d.morningWeight), 0) / second7.length;
          const avgB = first7.reduce((s,d)=> s + safeNum(d.morningWeight), 0) / first7.length;

          realWkKg = (avgA - avgB);
        }

        return {
          n: last7.length,
          spendAvg, eatAvg, defAvg,
          projWkKg,
          quality: { days:last7.length, spendDays, eatDays, weightDays },
          theoWkKg: projWkKg,
          realWkKg
        };
      }

      function render7dEnergyTrendUI(dateStr) {
        const elSpend = $("avg7SpendKcal");
        const elEat   = $("avg7EatKcal");
        const elDef   = $("avg7DefKcal");
        const elProj  = $("projWkKg");
        const elCmp   = $("deltaRealVsTheo");
        const elQual  = $("dataQuality7");
        const elNote  = $("trend7Note");

        if (!elSpend || !elEat || !elDef || !elProj || !elCmp || !elQual || !elNote) return;

        const daysArr = loadDays();
        const t = compute7dEnergyTrend(dateStr, daysArr);

        if (t.n === 0) {
          elSpend.value = "-";
          elEat.value   = "-";
          elDef.value   = "-";
          elProj.value  = "-";
          elCmp.value   = "-";
          elQual.value  = "-";
          elNote.textContent = "Aucune donnée exploitable pour la tendance 7j.";
          return;
        }

        elSpend.value = (t.spendAvg == null) ? "-" : Math.round(t.spendAvg);
        elEat.value   = (t.eatAvg == null)   ? "-" : Math.round(t.eatAvg);
        elDef.value   = (t.defAvg == null)   ? "-" : Math.round(t.defAvg);

        elProj.value  = (t.projWkKg == null) ? "-" : (round(t.projWkKg, 2) + " kg/sem");

        if (t.realWkKg == null || t.theoWkKg == null) {
          elCmp.value = "-";
        } else {
          const real = t.realWkKg;
          const theo = t.theoWkKg;
          const gap  = real - theo;
          elCmp.value = `réel ${round(real,2)} vs théorique ${round(theo,2)} (écart ${round(gap,2)})`;
        }

        elQual.value = `${t.quality.days}j | dépense:${t.quality.spendDays}/7 | repas:${t.quality.eatDays}/7 | poids:${t.quality.weightDays}/7`;

        let msg = "Lecture : compare surtout sur 7 jours. La dépense montre varie d’un jour à l’autre.";
        if (t.quality.eatDays < 5) msg += " ⚠️ Peu de jours avec repas enregistrés → tendance calories moins fiable."
        if (t.quality.spendDays < 5) msg += " ⚠️  Peu de jours avec dépense corrigée → tendance dépense moins fiable."
        if (t.quality.weightDays < 4) msg += " ⚠️ Peu de mesures de poids → comparaison réel/théorique fragile."

        elNote.textContent = msg;
      }

      function updateBodyCompUI(dateStr) {
        const d = getDay(dateStr);

        const mw = $("morningWeight");
        if (mw) mw.value = (toNum(d?.morningWeight) > 0) ? d.morningWeight : "";

        const fp = $("fatPct"); const mp = $("musclePct"); const bk = $("boneKg");
        if (fp) fp.value = (toNum(d?.fatPct) > 0) ? d.fatPct : "";
        if (mp) mp.value = (toNum(d?.musclePct) > 0) ? d.musclePct : "";
        if (bk) bk.value = (toNum(d?.boneKg) > 0) ? d.boneKg : "";

        const daysArr = loadDays();
        const { avg7, wkVar } = computeWeightStats(dateStr, daysArr);

        const a7 = $("avg7Weight"); const wv = $("wkVarPct");
        if (a7) a7.value = (avg7==null) ? "-" : round(avg7, 2);
        if (wv) wv.value = (wkVar==null) ? "-" : (round(wkVar, 2) + " %");

        const hCm = toNum($("height").value);
        const hM = hCm > 0 ? hCm / 100 : 0;
        const wMorning = toNum($("morningWeight")?.value);
        const wProfile = toNum($("weight").value);
        const wUsed = (wMorning > 0) ? wMorning : wProfile;

        let bmi = null;
        if (hM > 0 && wUsed > 0) bmi = wUsed / (hM * hM);

        const bwu = $("bmiWeightUsed"); const bv = $("bmiVal"); const bc = $("bmiCat");
        if (bwu) bwu.value = (wUsed > 0) ? round(wUsed,1) + " kg" : "-";
        if (bv) bv.value = (bmi==null) ? "-" : round(bmi, 1);
        if (bc) bc.value = (bmi==null) ? "-" : bmiCategory(bmi);

        render7dEnergyTrendUI(dateStr);
      }

      function saveBodyCompForDay(dateStr) {
        const existing = getDay(dateStr) || { date: dateStr };
        const dayObj = {
          ...existing,
          date: dateStr,
          morningWeight: (toNum($("morningWeight")?.value) > 0) ? toNum($("morningWeight").value) : null,
          fatPct: (toNum($("fatPct")?.value) > 0) ? toNum($("fatPct").value) : null,
          musclePct: (toNum($("musclePct")?.value) > 0) ? toNum($("musclePct").value) : null,
          boneKg: (toNum($("boneKg")?.value) > 0) ? toNum($("boneKg").value) : null,
          updatedAt: new Date().toISOString()
        };
        upsertDay(dayObj);
      }

      function renderDaysHistory() {
        const box = $("daysHistory");
        if (!box) return;

        const days = loadDays().sort((a,b) => b.date.localeCompare(a.date));
        if (days.length === 0) {
          box.innerHTML = "<p class='muted'>Aucune journée enregistrée (profil actif).</p>";
          return;
        }

        box.innerHTML = `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Poids</th>
                  <th>Montre</th>
                  <th>Dépense corrigée</th>
                  <th>Régime</th>
                  <th>Objectif %</th>
                  <th>Cible kcal</th>
                  <th>Repas</th>
                </tr>
              </thead>
              <tbody>
                ${days.map(d => {
                  const goal = (d.goalPct != null) ? d.goalPct : 0;
                  return `
                    <tr>
                      <td>${d.date}</td>
                      <td>${(toNum(d.morningWeight)>0) ? round(d.morningWeight,1) : "-"}</td>
                      <td>${Math.round(d.montreRaw ?? 0)}</td>
                      <td>${Math.round(d.montreAdjusted ?? 0)}</td>
                      <td>${escapeHtml(dietLabel(d.dietMode))}</td>
                      <td>${Math.round(goal ?? 0)}%</td>
                      <td>${Math.round(d.targetKcal ?? 0)}</td>
                      <td>${Array.isArray(d.meals) ? d.meals.length : 0}</td>
                    </tr>
                  `;
                }).join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      function loadDayIntoForm(dateStr) {
        const d = getDay(dateStr);
        if (!d) return;
        $("dayDate").value = d.date;

        if (d.watchBrand) $("watchBrand").value = d.watchBrand;
        applyBrandPreset($("watchBrand").value, false);

        if (d.montreRaw != null) $("montre").value = d.montreRaw;
        if (d.errPct != null && $("errPct")) $("errPct").value = d.errPct;
        if (d.errMode && $("errMode")) $("errMode").value = d.errMode;

        if (d.dietMode && $("dietMode")) $("dietMode").value = d.dietMode;

        if (d.goalPct != null && $("goalPct")) $("goalPct").value = d.goalPct;
        if (d.protPerKg != null && $("protPerKg")) $("protPerKg").value = d.protPerKg;
        if (d.fatPerKg != null && $("fatPerKg")) $("fatPerKg").value = d.fatPerKg;

        if ($("dietMode")) setDietNote($("dietMode").value, false);

        renderMealsTable(d.date);
        updateBodyCompUI(d.date);
        compute(true);
      }

      function compute(saveToJournal=true, scrollToResults=false) {
        const sex = $("sex").value;
        const age = toNum($("age").value);
        const h = toNum($("height").value);
        const w = toNum($("weight").value);

        const montre = toNum($("montre").value);
        const errPct = Math.max(0, toNum($("errPct")?.value));
        const errMode = $("errMode")?.value || "conservative";

        const dietMode = $("dietMode")?.value || "cut_standard";

        const goalPctRaw = toNum($("goalPct")?.value);
        const goalPct = clamp(goalPctRaw, 60, 130);
        if ($("goalPct") && goalPct !== goalPctRaw) $("goalPct").value = goalPct;

        const protPerKg = Math.max(0, toNum($("protPerKg")?.value));
        const fatPerKg  = Math.max(0, toNum($("fatPerKg")?.value));

        const dateForDay = getSelectedDate();
        $("dayDate").value = dateForDay;

        const eaten = syncEatenFromMeals(dateForDay);
        const eatenK = eaten.k, eatenP = eaten.p, eatenC = eaten.c, eatenF = eaten.f;

        const errFactor = errPct / 100;
        let montreAdjusted = montre;
        if (errMode === "conservative") montreAdjusted = montre * (1 - errFactor);
        if (errMode === "optimistic")   montreAdjusted = montre * (1 + errFactor);

        const targetKcal = montreAdjusted * (goalPct/100);

        const targetP = protPerKg * w;
        const targetF = fatPerKg  * w;
        const kcalFromPF = (targetP * 4) + (targetF * 9);
        const kcalLeftForC = targetKcal - kcalFromPF;

        const targetCraw = kcalLeftForC / 4;
        const targetCshow = Math.max(0, targetCraw);

        const remK = targetKcal - eatenK;
        const remP = targetP - eatenP;
        const remC = targetCraw - eatenC;
        const remF = targetF - eatenF;

        const remKShow = Math.max(0, remK);
        const remPShow = Math.max(0, remP);
        const remCShow = Math.max(0, remC);
        const remFShow = Math.max(0, remF);

        const bmr = mifflinStJeor(sex, w, h, age);
        updateBodyCompUI(dateForDay);

        if ($("out")) {
          $("out").style.display = "block";
          if (scrollToResults) $("out").scrollIntoView({ behavior:"smooth", block:"start" });
        }

        const kpis = $("kpis");
        if (kpis) {
          kpis.innerHTML = "";
          const mk = (title, value, cls="") => {
            const d = document.createElement("div");
            if (cls) d.className = cls;
            d.innerHTML = `<b>${title}</b>${value}`;
            return d;
          };

          const dietBadge = makeDietBadge(dietMode, goalPct);
          kpis.appendChild(mk("Régime", dietBadge));
          kpis.appendChild(mk("Objectif (%)", round(goalPct,0) + "%"));
          kpis.appendChild(mk("Montre saisie (kcal)", round(montre,0)));
          kpis.appendChild(mk("Dépense corrigée (kcal)", round(montreAdjusted,0), "warn"));
          kpis.appendChild(mk("Cible (kcal)", round(targetKcal,0), "ok"));

          const bmrKpi = mk("BMR estimé (kcal)", round(bmr,0));
          bmrKpi.setAttribute("data-um","expert");
          kpis.appendChild(bmrKpi);
        }

        if ($("tK")) $("tK").textContent = round(targetKcal, 0);
        if ($("tP")) $("tP").textContent = round(targetP, 1);
        if ($("tC")) $("tC").textContent = round(targetCshow, 1);
        if ($("tF")) $("tF").textContent = round(targetF, 1);

        if ($("eK"))  $("eK").textContent  = round(eatenK, 0);
        if ($("eP2")) $("eP2").textContent = round(eatenP, 1);
        if ($("eC2")) $("eC2").textContent = round(eatenC, 1);
        if ($("eF2")) $("eF2").textContent = round(eatenF, 1);

        if ($("rK")) $("rK").textContent = round(remKShow, 0);
        if ($("rP")) $("rP").textContent = round(remPShow, 1);
        if ($("rC")) $("rC").textContent = round(remCShow, 1);
        if ($("rF")) $("rF").textContent = round(remFShow, 1);

        let note = `Objectif appliqué: ${round(goalPct,0)}% de la dépense corrigée. Mode erreur: ${errMode} (±${round(errPct,0)}%).`;
        if (kcalLeftForC < 0) {
          note += " ⚠️ Protéines + lipides dépassent les calories cibles → glucides affichés clampés à 0. Réduis prot/lip ou augmente l’objectif (%).";
        }
        if ($("notes")) $("notes").textContent = note;

        if (saveToJournal) {
          const existing = getDay(dateForDay) || { date: dateForDay };
          const meals = getMealsForDay(dateForDay);

          const dayObj = {
            ...existing,
            date: dateForDay,

            watchBrand: $("watchBrand").value,
            montreRaw: montre,
            montreAdjusted,
            errPct,
            errMode,

            dietMode: dietMode,
            goalPct,

            protPerKg,
            fatPerKg,

            meals,
            eaten: { k: eatenK, p: eatenP, c: eatenC, f: eatenF },

            targetKcal, targetP, targetC: targetCraw, targetF,
            remaining: { k: remK, p: remP, c: remC, f: remF },

            morningWeight: (toNum($("morningWeight")?.value) > 0) ? toNum($("morningWeight").value) : (existing.morningWeight ?? null),
            fatPct: (toNum($("fatPct")?.value) > 0) ? toNum($("fatPct").value) : (existing.fatPct ?? null),
            musclePct: (toNum($("musclePct")?.value) > 0) ? toNum($("musclePct").value) : (existing.musclePct ?? null),
            boneKg: (toNum($("boneKg")?.value) > 0) ? toNum($("boneKg").value) : (existing.boneKg ?? null),

            bmr,
            updatedAt: new Date().toISOString()
          };

          upsertDay(dayObj);
          saveProfileSettings();
        }

        applyUseMode($("useMode")?.value || "simple");
      }

      /* =========================
         ✅ Cloud sync (pull/push)
         ========================= */
      function setCloudStatus(msg){
        const el = $("cloudStatus");
        if (el) el.textContent = "Statut : " + msg;
      }

      async function cloudGetUser(){
        if (!supa) return null;
        const { data, error } = await supa.auth.getUser();
        if (error) return null;
        return data?.user || null;
      }

      function buildLocalSnapshot(profileId){
        let settings = null;
        try { settings = JSON.parse(localStorage.getItem(settingsKeyFor(profileId)) || "null"); } catch {}
        let days = [];
        try { days = JSON.parse(localStorage.getItem(daysKeyFor(profileId)) || "[]"); } catch { days = []; }

        return {
          schemaVersion: 1,
          profileId,
          settings: settings || null,
          days: Array.isArray(days) ? days : [],
          updatedAt: new Date().toISOString()
        };
      }

      function writeSnapshotToLocal(snapshot){
        const profileId = snapshot?.profileId || getActiveProfile() || "default";
        if (snapshot?.settings) localStorage.setItem(settingsKeyFor(profileId), JSON.stringify(snapshot.settings));
        if (Array.isArray(snapshot?.days)) localStorage.setItem(daysKeyFor(profileId), JSON.stringify(snapshot.days));
      }

      function mergeSnapshots(localSnap, cloudSnap){
        if (!cloudSnap) return localSnap;
        if (!localSnap) return cloudSnap;

        const out = {
          schemaVersion: 1,
          profileId: localSnap.profileId || cloudSnap.profileId || "default",
          settings: null,
          days: [],
          updatedAt: new Date().toISOString()
        };

        const lS = localSnap.settings;
        const cS = cloudSnap.settings;
        const lAt = (lS && lS.updatedAt) ? String(lS.updatedAt) : "";
        const cAt = (cS && cS.updatedAt) ? String(cS.updatedAt) : "";
        out.settings = (cAt > lAt) ? cS : lS;

        const lDays = Array.isArray(localSnap.days) ? localSnap.days : [];
        const cDays = Array.isArray(cloudSnap.days) ? cloudSnap.days : [];

        const map = new Map();
        for (const d of lDays) if (d?.date) map.set(d.date, d);
        for (const d of cDays) {
          if (!d?.date) continue;
          const existing = map.get(d.date);
          if (!existing) { map.set(d.date, d); continue; }

          const eAt = String(existing.updatedAt || "");
          const dAt = String(d.updatedAt || "");
          const winner = (dAt > eAt) ? d : existing;
          const loser  = (dAt > eAt) ? existing : d;

          const wm = Array.isArray(winner.meals) ? winner.meals : [];
          const lm = Array.isArray(loser.meals) ? loser.meals : [];
          const mm = new Map();
          for (const m of lm) if (m?.id) mm.set(m.id, m);
          for (const m of wm) if (m?.id) mm.set(m.id, m);
          const mergedMeals = Array.from(mm.values()).sort((a,b)=> String(a.createdAt||"").localeCompare(String(b.createdAt||"")));

          map.set(d.date, { ...winner, meals: mergedMeals, updatedAt: winner.updatedAt || new Date().toISOString() });
        }

        out.days = Array.from(map.values()).sort((a,b)=> String(a.date).localeCompare(String(b.date)));
        return out;
      }

      async function cloudPull(){
        if (!supa) { setCloudStatus("Sync inactive (Supabase non configuré)."); return; }
        const user = await cloudGetUser();
        if (!user) { setCloudStatus("Non connecté."); return; }

        const profileId = getActiveProfile() || "default";

        const { data, error } = await supa
          .from("cloud_profiles")
          .select("payload, updated_at")
          .eq("user_id", user.id)
          .eq("profile_id", profileId)
          .maybeSingle();

        if (error) { setCloudStatus("Erreur pull : " + error.message); return; }
        if (!data?.payload) { setCloudStatus("Aucune sauvegarde cloud pour ce profil."); return; }

        const localSnap = buildLocalSnapshot(profileId);
        const cloudSnap = data.payload;
        const merged = mergeSnapshots(localSnap, cloudSnap);

        writeSnapshotToLocal(merged);

        loadProfileSettings();
        refreshDaySelect();
        renderDaysHistory();
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);

        setCloudStatus("Pull OK (cloud → local).");
      }

      async function cloudPush(){
        if (!supa) { setCloudStatus("Sync inactive (Supabase non configuré)."); return; }
        const user = await cloudGetUser();
        if (!user) { setCloudStatus("Non connecté."); return; }

        const profileId = getActiveProfile() || "default";
        const localSnap = buildLocalSnapshot(profileId);

        const row = {
          user_id: user.id,
          profile_id: profileId,
          payload: localSnap,
          updated_at: new Date().toISOString()
        };

        const { error } = await supa
          .from("cloud_profiles")
          .upsert(row, { onConflict: "user_id,profile_id" });

        if (error) { setCloudStatus("Erreur push : " + error.message); return; }

        setCloudStatus("Push OK (local → cloud).");
      }

      async function cloudSync(){
        if (!supa) { setCloudStatus("Sync inactive (Supabase non configuré)."); return; }
        const user = await cloudGetUser();
        if (!user) { setCloudStatus("Non connecté."); return; }

        const profileId = getActiveProfile() || "default";

        const { data, error } = await supa
          .from("cloud_profiles")
          .select("payload")
          .eq("user_id", user.id)
          .eq("profile_id", profileId)
          .maybeSingle();

        if (error) { setCloudStatus("Erreur pull : " + error.message); return; }

        const localSnap = buildLocalSnapshot(profileId);
        const cloudSnap = data?.payload || null;

        const merged = mergeSnapshots(localSnap, cloudSnap);

        writeSnapshotToLocal(merged);

        const row = {
          user_id: user.id,
          profile_id: profileId,
          payload: merged,
          updated_at: new Date().toISOString()
        };

        const { error: pushErr } = await supa
          .from("cloud_profiles")
          .upsert(row, { onConflict: "user_id,profile_id" });

        if (pushErr) { setCloudStatus("Merge OK mais push KO : " + pushErr.message); return; }

        loadProfileSettings();
        refreshDaySelect();
        renderDaysHistory();
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);

        setCloudStatus("Sync OK (Pull → Merge → Push).");
      }

      async function cloudLoginWithEmail(email){
        if (!supa) { setCloudStatus("Sync inactive (Supabase non configuré)."); return; }
        const e = String(email||"").trim();
        if (!e) { setCloudStatus("Entre un email."); return; }

        const { error } = await supa.auth.signInWithOtp({
          email: e,
          options: { emailRedirectTo: window.location.href }
        });

        if (error) { setCloudStatus("Erreur login : " + error.message); return; }
        setCloudStatus("Lien envoyé. Ouvre tes emails et clique le lien.");
      }

      async function cloudLogout(){
        if (!supa) { setCloudStatus("Sync inactive (Supabase non configuré)."); return; }
        await supa.auth.signOut();
        setCloudStatus("Déconnecté (local uniquement).");
      }

      function isSportOrExpert(){
        const m = document.body.getAttribute("data-usemode");
        return (m === "sport" || m === "expert");
      }

      function openWatchInfoModal(text){
        const modal = $("watchInfoModal");
        const body  = $("watchInfoBody");
        if (!modal || !body) return;
        body.textContent = text || "Aucune information.";
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeWatchInfoModal(){
        const modal = $("watchInfoModal");
        if (!modal) return;
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      }

      /* ---------------- Events ---------------- */
      $("btnCreateProfile")?.addEventListener("click", () => createOrActivateProfile($("profileName").value));
      $("btnDeleteProfile")?.addEventListener("click", deleteActiveProfile);

      $("watchBrand")?.addEventListener("change", () => {
        applyBrandPreset($("watchBrand").value, true);
        saveProfileSettings();
        compute(true);
      });

      $("profileSelect")?.addEventListener("change", (e) => {
        setActiveProfile(e.target.value);
        loadProfileSettings();
        $("dayDate").value = isoToday();
        refreshDaySelect();
        renderDaysHistory();
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);
      });

      $("dietMode")?.addEventListener("change", () => {
        const mode = $("dietMode").value;
        if (mode !== "custom") applyDietPreset(mode);
        else setDietNote("custom", false);
        saveProfileSettings();
        compute(true);
      });

      $("useMode")?.addEventListener("change", () => {
        applyUseMode($("useMode").value);
        saveProfileSettings();
        compute(true);
      });

      $("watchProfileInfo")?.addEventListener("click", (e) => {
        if (!isSportOrExpert()) return;
        const text = e.currentTarget.getAttribute("data-modaltext") || "";
        openWatchInfoModal(text);
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeWatchInfoModal();
      });

      ["goalPct","protPerKg","fatPerKg"].forEach(id => {
        $(id)?.addEventListener("change", () => {
          forceCustomIfPresetEdited();
          saveProfileSettings();
          compute(true);
        });
      });

      $("calcBtn")?.addEventListener("click", () => compute(true, true));
      $("calcSpendBtn")?.addEventListener("click", () => compute(true, true));

      $("btnAddMeal")?.addEventListener("click", addMealFromInputs);
      $("btnClearMeals")?.addEventListener("click", clearMealsForDay);
      $("btnApplyPer100")?.addEventListener("click", applyPer100ToMeal);

      $("btnLoadDay")?.addEventListener("click", () => {
        const date = $("daySelect").value;
        if (date) loadDayIntoForm(date);
      });

      $("btnDeleteDay")?.addEventListener("click", () => {
        const date = getSelectedDate();
        if (!date) return;
        deleteDay(date);
        renderMealsTable(getSelectedDate());
        updateBodyCompUI(getSelectedDate());
        compute(true);
      });

      $("btnExportDays")?.addEventListener("click", exportDays);
      $("btnImportDays")?.addEventListener("click", importDays);
      $("btnClearDays")?.addEventListener("click", clearDays);

      $("btnCloudLogin")?.addEventListener("click", () => cloudLoginWithEmail($("cloudEmail")?.value));
      $("btnCloudLogout")?.addEventListener("click", cloudLogout);
      $("btnCloudPull")?.addEventListener("click", cloudPull);
      $("btnCloudPush")?.addEventListener("click", cloudPush);
      $("btnCloudSync")?.addEventListener("click", cloudSync);

      $("dayDate")?.addEventListener("change", () => {
  const d = getSelectedDate();
  // Si la journée existe en local, on la charge entièrement (repas + dépense + suivi poids/compo + paramètres du jour)
  if (getDay(d)) {
    loadDayIntoForm(d);
    return;
  }
  // Sinon: journée “vide” mais on rafraîchit quand même l’UI
  renderMealsTable(d);
  updateBodyCompUI(d);
  compute(true);
});


      const autoSaveIds = ["sex","age","height","weight","montre","errPct","errMode","dietMode"];
      autoSaveIds.forEach(id => $(id)?.addEventListener("change", () => { saveProfileSettings(); compute(true); }));

      ["morningWeight","fatPct","musclePct","boneKg"].forEach(id => {
        const el = $(id);
        if (!el) return;
        el.addEventListener("change", () => {
          const dateStr = getSelectedDate();
          saveBodyCompForDay(dateStr);
          updateBodyCompUI(dateStr);
          compute(true);
        });
      });

      $("watchInfoClose")?.addEventListener("click", closeWatchInfoModal);
      $("watchInfoOk")?.addEventListener("click", closeWatchInfoModal);
      document.querySelector("#watchInfoModal .modal__backdrop")?.addEventListener("click", closeWatchInfoModal);

      /* ---------------- Init ---------------- */
      initTabs();

      ensureDefaultProfile();
      refreshProfileSelect();

      if ($("dayDate")) $("dayDate").value = isoToday();

      applyBrandPreset($("watchBrand").value, true);

      loadProfileSettings();
      if ($("dietMode")?.value && $("dietMode").value !== "custom") setDietNote($("dietMode").value, false);

      refreshDaySelect();
      renderDaysHistory();
      renderMealsTable(getSelectedDate());
      updateBodyCompUI(getSelectedDate());
      applyUseMode($("useMode")?.value || "simple");

      (async () => {
        if (!supa) { setCloudStatus("local uniquement (Supabase non configuré)."); return; }
        await handleMagicLinkCallback();
        const user = await cloudGetUser();
        setCloudStatus(user ? ("connecté : " + (user.email || "utilisateur")) : "non connecté.");
      })();

      compute(true);
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js");
        });
      }
    </script>

  </div> <!-- /container -->
</body>
</html>
